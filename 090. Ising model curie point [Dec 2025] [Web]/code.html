<!DOCTYPE html>
<html>
	<head>
		<title>Page Title</title>
		<script id="vertexShader" type="x-shader/x-vertex">#version 300 es
in vec2 coordinates;

out vec2 texCoords;

void main() {
	gl_Position = vec4(coordinates, 0.0, 1.0);
	texCoords = coordinates * 0.5 + 0.5;
}
		</script>
		<script id="initFragShader" type="x-shader/x-fragment">#version 300 es
precision highp float;

in highp vec2 texCoords;

uniform float texSize;
uniform sampler2D sampler;
uniform highp float random;

out vec4 FragColor;

float hash13(vec3 p3) {
	p3  = fract(p3 * .1031);
    p3 += dot(p3, p3.zyx + 31.32);
    return fract((p3.x + p3.y) * p3.z);
}

float rand(vec2 v) {
	return hash13(vec3(v * texSize, random));
}

void main() {
	vec4 color = vec4(0.0, 0.0, 0.0, 0.0);
	
	if (rand(texCoords) > 0.5) {
		color = vec4(1.0, 0.0, 0.0, 0.0);
	}
	
	FragColor = color;
}
		</script>
		<script id="compFragShader" type="x-shader/x-fragment">#version 300 es
precision highp float;

in highp vec2 texCoords;

uniform float texSize;
uniform sampler2D sampler;
uniform float random;
uniform int iteration;

out vec4 FragColor;

float hash13(vec3 p3) {
	p3  = fract(p3 * .1031);
    p3 += dot(p3, p3.zyx + 31.32);
    return fract((p3.x + p3.y) * p3.z);
}

float rand(vec2 v) {
	return hash13(vec3(v * texSize, random));
}

vec4 getPixel(vec2 coords) {
	float pixelSize = 1.0 / texSize;
	vec2 pixelCoords = pixelSize * coords + texCoords;
	return texture(sampler, pixelCoords);
}

// the offsets of 0.000556 and 0.005 are presumably necessary due to imperfections in the RNG functions I'm using
float chemicalPotential = 2.000556;
float temperature = 0.5 / log(1.0 + sqrt(2.0)) + 0.005;

void main() {
	float potential = chemicalPotential;

	potential -= getPixel(vec2( 1.0,  0.0)).x;
	potential -= getPixel(vec2( 0.0,  1.0)).x;
	potential -= getPixel(vec2(-1.0,  0.0)).x;
	potential -= getPixel(vec2( 0.0, -1.0)).x;

	float fillProbability = ((tanh(-0.5 * potential / temperature) + 1.0) / 2.0 + 0.0 * getPixel(vec2(0.0)).x) / 1.0;

	vec4 color;

	if (rand(texCoords) + 0.0 * 0.000071 < fillProbability) {
		color = vec4(1.0, 0.0, 0.0, 0.0);
	} else {
		color = vec4(0.0);
	}

	vec2 a = fract(texCoords * texSize * 0.5);

	if (((a.x > 0.5 && a.y > 0.5) || (a.x < 0.5 && a.y < 0.5)) ^^ iteration % 2 == 0) {
		FragColor = color;
	} else {
		FragColor = getPixel(vec2(0.0));
	}
}
		</script>
		<script id="displayFragShader" type="x-shader/x-fragment">#version 300 es
precision highp float;

in highp vec2 texCoords;

uniform float texSize;
uniform sampler2D sampler;

out vec4 FragColor;

void main() {
	FragColor = vec4(texture(sampler, texCoords).xyz, 1.0);
}
		</script>
	</head>
	<body>
		<div id="container">
			<span id="speedMeter"></span>
			<br />
			<span id="fpsCounter"></span>
			<br />
			<span id="throughputMeter"></span>
		</div>
		<canvas id="can"></canvas>
	</body>
</html>

